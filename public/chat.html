<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>GymBuddy</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      background: #000; color: #fff; height: 100vh; height: 100dvh;
      display: flex; flex-direction: column; overflow: hidden;
    }

    /* iPhone-style header */
    .nav {
      background: #1c1c1e; padding: 0.5rem 1rem 0.6rem;
      display: flex; align-items: center; gap: 0.75rem;
      border-bottom: 0.5px solid #38383a;
    }
    .nav .avatar {
      width: 36px; height: 36px; border-radius: 50%; background: #30d158;
      display: flex; align-items: center; justify-content: center;
      font-size: 1rem; font-weight: 700;
    }
    .nav .info { flex: 1; }
    .nav .name { font-size: 0.95rem; font-weight: 600; }
    .nav .status-text { font-size: 0.7rem; color: #8e8e93; }

    /* Setup screen */
    .setup {
      flex: 1; display: flex; flex-direction: column; align-items: center;
      justify-content: center; gap: 1rem; padding: 2rem;
    }
    .setup .logo {
      width: 80px; height: 80px; border-radius: 50%; background: #30d158;
      display: flex; align-items: center; justify-content: center;
      font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;
    }
    .setup h2 { font-size: 1.3rem; font-weight: 600; }
    .setup p { color: #8e8e93; font-size: 0.9rem; text-align: center; max-width: 300px; line-height: 1.4; }
    .setup input {
      padding: 0.7rem 1rem; border-radius: 10px; border: none;
      background: #2c2c2e; color: #fff; width: 280px; font-size: 1rem;
      text-align: center; outline: none;
    }
    .setup input::placeholder { color: #636366; }
    .setup .start-btn {
      padding: 0.7rem 2rem; border-radius: 10px; border: none;
      background: #30d158; color: #fff; font-weight: 600;
      font-size: 1rem; cursor: pointer;
    }
    .setup .start-btn:active { background: #28a745; }
    .setup .error { color: #ff453a; font-size: 0.85rem; }

    /* Messages area */
    .messages {
      flex: 1; overflow-y: auto; padding: 0.75rem 1rem;
      display: flex; flex-direction: column; gap: 0.35rem;
      background: #000; -webkit-overflow-scrolling: touch;
    }
    .msg-row { display: flex; flex-direction: column; }
    .msg-row.user { align-items: flex-end; }
    .msg-row.bot { align-items: flex-start; }
    .bubble {
      max-width: 75%; padding: 0.55rem 0.85rem; font-size: 0.92rem;
      line-height: 1.35; white-space: pre-wrap; word-wrap: break-word;
    }
    .msg-row.bot .bubble {
      background: #2c2c2e; color: #fff;
      border-radius: 18px 18px 18px 6px;
    }
    .msg-row.user .bubble {
      background: #30d158; color: #fff;
      border-radius: 18px 18px 6px 18px;
    }
    .msg-time {
      font-size: 0.65rem; color: #636366;
      margin-top: 0.15rem; padding: 0 0.25rem;
    }
    .typing {
      display: none; align-items: center; gap: 0.3rem;
      padding: 0.5rem 0.85rem; background: #2c2c2e;
      border-radius: 18px; align-self: flex-start; margin-top: 0.25rem;
    }
    .typing.show { display: flex; }
    .typing span {
      width: 7px; height: 7px; border-radius: 50%; background: #636366;
      animation: blink 1.4s infinite both;
    }
    .typing span:nth-child(2) { animation-delay: 0.2s; }
    .typing span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes blink { 0%,80%,100%{opacity:.3} 40%{opacity:1} }

    /* Input bar */
    .input-bar {
      background: #1c1c1e; padding: 0.5rem 0.75rem 1.5rem;
      display: flex; align-items: center; gap: 0.5rem;
      border-top: 0.5px solid #38383a;
    }
    .input-bar input {
      flex: 1; padding: 0.55rem 0.85rem; border-radius: 20px;
      border: 0.5px solid #38383a; background: #2c2c2e;
      color: #fff; font-size: 0.95rem; outline: none;
    }
    .input-bar input:focus { border-color: #30d158; }
    .input-bar input::placeholder { color: #636366; }
    .send-btn {
      width: 32px; height: 32px; border-radius: 50%;
      background: #30d158; border: none; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; transition: opacity 0.15s;
    }
    .send-btn:disabled { opacity: 0.3; cursor: default; }
    .send-btn svg { width: 16px; height: 16px; fill: #fff; }
  </style>
</head>
<body>

  <!-- Setup -->
  <div id="setup" class="setup">
    <div class="logo">GB</div>
    <h2>GymBuddy</h2>
    <p>Enter the phone number you signed up with to start chatting with your gym buddy.</p>
    <input type="tel" id="phoneInput" placeholder="+1 (404) 451-1216" />
    <button class="start-btn" onclick="startChat()">Start Chat</button>
    <p id="setupError" class="error" style="display:none"></p>
  </div>

  <!-- Chat -->
  <div id="chatArea" style="display:none; flex:1; flex-direction:column;">
    <div class="nav">
      <div class="avatar">GB</div>
      <div class="info">
        <div class="name">GymBuddy</div>
        <div class="status-text" id="statusText">Online</div>
      </div>
    </div>
    <div class="messages" id="messages">
      <div class="typing" id="typing"><span></span><span></span><span></span></div>
    </div>
    <div class="input-bar">
      <input type="text" id="msgInput" placeholder="Message" onkeydown="if(event.key==='Enter')sendMsg()" />
      <button class="send-btn" id="sendBtn" onclick="sendMsg()">
        <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
      </button>
    </div>
  </div>

  <script>
    let phone = '';

    async function startChat() {
      phone = document.getElementById('phoneInput').value.trim();
      if (!phone) return;
      if (!phone.startsWith('+')) phone = '+1' + phone.replace(/\D/g, '');

      const res = await fetch('/api/chat/messages?phone=' + encodeURIComponent(phone));
      const data = await res.json();

      if (!data.user) {
        const err = document.getElementById('setupError');
        err.textContent = 'No account with this number. Sign up first.';
        err.style.display = 'block';
        return;
      }

      document.getElementById('setup').style.display = 'none';
      const chatArea = document.getElementById('chatArea');
      chatArea.style.display = 'flex';

      if (data.messages.length === 0) {
        showTyping();
        const startRes = await fetch('/api/chat/start-onboarding', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone })
        });
        const startData = await startRes.json();
        hideTyping();
        renderMessages(startData.messages);
      } else {
        renderMessages(data.messages);
      }

      document.getElementById('msgInput').focus();
    }

    async function sendMsg() {
      const input = document.getElementById('msgInput');
      const msg = input.value.trim();
      if (!msg) return;

      input.value = '';
      document.getElementById('sendBtn').disabled = true;

      // Immediately show user message
      addMessage('user', msg);

      // Show typing indicator
      showTyping();
      document.getElementById('statusText').textContent = 'typing...';

      const res = await fetch('/api/chat/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone, message: msg })
      });
      const data = await res.json();

      // Small delay to feel natural
      await new Promise(r => setTimeout(r, 800));
      hideTyping();
      document.getElementById('statusText').textContent = 'Online';
      renderMessages(data.messages);

      document.getElementById('sendBtn').disabled = false;
      input.focus();
    }

    function addMessage(role, text) {
      const container = document.getElementById('messages');
      const typing = document.getElementById('typing');
      const row = document.createElement('div');
      row.className = 'msg-row ' + role;

      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerHTML = escapeHtml(text);
      row.appendChild(bubble);

      container.insertBefore(row, typing);
      scrollToBottom();
    }

    function renderMessages(messages) {
      const container = document.getElementById('messages');
      const typing = document.getElementById('typing');

      // Clear everything except typing indicator
      while (container.firstChild !== typing && container.firstChild) {
        container.removeChild(container.firstChild);
      }

      for (const m of messages) {
        const row = document.createElement('div');
        row.className = 'msg-row ' + m.role;

        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        bubble.innerHTML = escapeHtml(m.text);
        row.appendChild(bubble);

        const time = document.createElement('div');
        time.className = 'msg-time';
        time.textContent = m.time;
        row.appendChild(time);

        container.insertBefore(row, typing);
      }
      scrollToBottom();
    }

    function showTyping() {
      document.getElementById('typing').classList.add('show');
      scrollToBottom();
    }
    function hideTyping() {
      document.getElementById('typing').classList.remove('show');
    }
    function scrollToBottom() {
      const c = document.getElementById('messages');
      setTimeout(() => c.scrollTop = c.scrollHeight, 50);
    }
    function escapeHtml(t) {
      return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
    }
  </script>
</body>
</html>
